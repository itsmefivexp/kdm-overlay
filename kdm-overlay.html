<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDM Stream Overlay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&family=Cinzel:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #d1d5db; /* Light gray for text */
            text-shadow: 0 0 2px rgba(0,0,0,0.8);
        }
        .container {
            border: 2px solid #374151; /* Slate-700 */
            background: rgba(17, 24, 39, 0.85); /* Deep slate-900 with transparency */
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.9);
            position: relative;
        }
        .stat-bar {
            background-color: #374151; /* Slate-700 */
            border: 1px solid #4b5563; /* Slate-600 */
        }
        .stat-fill {
            transition: width 0.3s ease-in-out;
            border-radius: 9999px; /* Full rounded corners */
        }
        .survivor-section {
            display: flex;
            flex-wrap: nowrap; /* Prevent cards from wrapping */
            gap: 1.5rem; /* Increased gap */
            justify-content: center;
            overflow-x: auto; /* Allow horizontal scrolling if needed */
            padding-bottom: 1rem; /* Space for scrollbar */
        }
        .survivor-card {
            background-color: #1f2937; /* Darker slate-800 */
            border: 1px solid #374151;
            flex-shrink: 0; /* Prevent cards from shrinking */
            width: 250px;
        }
        .stat-input {
            width: 4rem;
            text-align: center;
        }
        .control-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8); /* Dark, semi-transparent overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .control-panel.is-visible {
            visibility: visible;
            opacity: 1;
        }
        .control-content {
            background: #111827; /* Deep slate-900 */
            border: 2px solid #4b5563;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.9);
            max-height: 90vh;
            overflow-y: auto;
            width: 95%;
            max-width: 600px; /* Widen control panel */
            padding: 2rem;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .injury-toggle {
            display: inline-flex;
            width: 1.5rem;
            height: 1.5rem;
            justify-content: center;
            align-items: center;
            border: 1px solid #4b5563;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            margin-left: 0.5rem;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .injury-low {
            background-color: #fca5a5; /* Red-300 */
            color: #7f1d1d; /* Red-900 */
        }
        .injury-high {
            background-color: #b91c1c; /* Red-700 */
            color: white;
        }
    </style>
</head>
<body class="p-4 md:p-10 flex items-center justify-center min-h-screen font-sans bg-transparent">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Main Overlay Container -->
    <div id="main-overlay" class="w-full max-w-7xl mx-auto rounded-xl p-6 md:p-12 transition-all duration-300 bg-transparent">

        <!-- Main stats container -->
        <main class="flex flex-col lg:flex-row gap-8">

            <!-- Survivor Stats Section -->
            <section id="survivor-stats" class="flex-grow">
                <h2 class="text-3xl font-bold border-b-2 border-gray-600 pb-3 mb-6 font-['Cinzel']">Survivors</h2>
                <div id="survivor-grid" class="survivor-section">
                    <!-- Survivor cards will be dynamically inserted here -->
                </div>
            </section>

            <!-- Monster Stats Section -->
            <section id="monster-stats" class="flex-none w-full lg:w-96">
                <h2 class="text-3xl font-bold border-b-2 border-gray-600 pb-3 mb-6 font-['Cinzel']">Monster</h2>
                <div id="monster-card" class="bg-zinc-900 p-6 rounded-xl shadow-lg">
                    <p class="text-2xl font-bold mb-4 text-center text-gray-200" id="monster-name">White Lion</p>
                    <div class="mt-6">
                        <label class="text-md text-gray-400">Life: <span class="font-bold text-white" id="monster-life-text">20 / 20</span></label>
                        <div class="relative pt-2">
                            <div class="overflow-hidden h-4 flex rounded-full bg-zinc-800 border-2 border-zinc-700">
                                <div id="monster-life-fill" style="width: 100%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-red-600 transition-all duration-300"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>

        <!-- General info and Footer -->
        <footer class="text-center mt-10 text-gray-500 text-sm">
            <p>Overlay powered by Firebase. Press <kbd>Esc</kbd> to toggle controls.</p>
        </footer>
    </div>

    <!-- Control Panel -->
    <div id="control-panel" class="control-panel">
        <div class="control-content rounded-xl">
            <h2 class="text-3xl font-bold mb-6 text-center font-['Cinzel']">Control Panel</h2>

            <!-- Warning message for local mode -->
            <div id="local-mode-warning" class="hidden bg-red-900 text-red-200 p-4 rounded-md mb-6 text-center text-sm border-2 border-red-700">
                Connection failed. Your changes will not be saved.
            </div>

            <!-- General Game Info Controls -->
            <div class="mb-6 border-b-2 border-gray-700 pb-4">
                <label for="year-input" class="block text-gray-300 font-semibold mb-2">Game Year</label>
                <input id="year-input" type="number" min="1" class="w-full p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>

            <!-- Monster Controls -->
            <div class="mb-6 border-b-2 border-gray-700 pb-4">
                <h3 class="text-xl font-bold mb-4 font-['Cinzel']">Monster Stats</h3>
                <div class="mb-2">
                    <label for="monster-name-input" class="block text-gray-300 font-semibold mb-1">Monster Name</label>
                    <input id="monster-name-input" type="text" class="w-full p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-2">
                    <label for="monster-life-input" class="block text-gray-300 font-semibold mb-1">Current Life</label>
                    <input id="monster-life-input" type="number" min="0" class="w-full p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="monster-max-life-input" class="block text-gray-300 font-semibold mb-1">Max Life</label>
                    <input id="monster-max-life-input" type="number" min="1" class="w-full p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>

            <!-- Survivor Controls -->
            <div id="survivor-controls" class="space-y-6">
                <h3 class="text-xl font-bold mb-4 font-['Cinzel']">Survivor Stats</h3>
                <!-- Survivor input fields will be dynamically added here -->
            </div>

            <button id="close-btn" class="mt-8 w-full py-3 bg-red-800 text-white rounded-md font-bold hover:bg-red-900 transition duration-200 shadow-lg hover:shadow-xl">Close</button>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed bottom-4 left-4 p-4 bg-gray-800 text-white rounded-lg shadow-lg hidden z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // These global variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Hardcoded Firebase configuration from user request
        const hardcodedFirebaseConfig = {
            apiKey: "AIzaSyBZWJ-41VDkBrfwoup1TfBeG_eCh6wDfJk",
            authDomain: "kdm-overlay-partduex.firebaseapp.com",
            projectId: "kdm-overlay-partduex",
            storageBucket: "kdm-overlay-partduex.firebasestorage.app",
            messagingSenderId: "975715726701",
            appId: "1:975715726701:web:08f846b03d19603e85d664",
            measurementId: "G-1GNQXZD29F"
        };
        
        // Use the dynamic canvas variable if available, otherwise fall back to the user's hardcoded config.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : hardcodedFirebaseConfig;

        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        let currentGameState = null;
        let isConnected = false;
        
        const showMessageBox = (message, type = 'info') => {
            const messageBox = document.getElementById('message-box');
            if (messageBox) {
                messageBox.textContent = message;
                messageBox.className = `fixed bottom-4 left-4 p-4 rounded-lg shadow-lg block z-50 transition-all duration-300 ease-in-out`;
                if (type === 'error') {
                    messageBox.classList.add('bg-red-800', 'text-white');
                } else {
                    messageBox.classList.add('bg-gray-800', 'text-white');
                }
                setTimeout(() => {
                    messageBox.classList.remove('block');
                    messageBox.classList.add('hidden');
                }, 3000);
            }
        };

        const hideLoadingOverlay = () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        };

        const setupFirebase = async () => {
            if (!firebaseConfig) {
                console.warn("Firebase configuration is missing. Running in local mode.");
                showMessageBox("Firebase config missing. Running locally.", 'error');
                fallbackToLocalMode();
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                isConnected = true;
                initDataListener();
                console.log("Successfully connected to Firebase.");
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showMessageBox("Connection failed. Check console for details.", 'error');
                fallbackToLocalMode();
            }
        };

        const fallbackToLocalMode = () => {
            currentGameState = initialGameState;
            updateUI(currentGameState);
            hideLoadingOverlay();
            isConnected = false;
            const warning = document.getElementById('local-mode-warning');
            if (warning) {
                warning.classList.remove('hidden');
            }
        };
        
        const getGameStateRef = () => {
            if (!db || !userId) {
                return null;
            }
            // Corrected Firestore document path to have an even number of segments
            return doc(db, 'artifacts', appId, 'public', 'data', 'game_state', 'kdm_stats');
        };

        const initialSurvivors = [
            { id: 'survivor-1', color: 'Blue', name: 'Survivor 1', survival: 0, insanity: 0, head: 0, body: 0, hands: 0, feet: 0, waist: 0, bleed: 0, maxBleed: 5, headInjury: 'none', bodyInjury: 'none', handsInjury: 'none', feetInjury: 'none', waistInjury: 'none' },
            { id: 'survivor-2', color: 'Red', name: 'Survivor 2', survival: 0, insanity: 0, head: 0, body: 0, hands: 0, feet: 0, waist: 0, bleed: 0, maxBleed: 5, headInjury: 'none', bodyInjury: 'none', handsInjury: 'none', feetInjury: 'none', waistInjury: 'none' },
            { id: 'survivor-3', color: 'Green', name: 'Survivor 3', survival: 0, insanity: 0, head: 0, body: 0, hands: 0, feet: 0, waist: 0, bleed: 0, maxBleed: 5, headInjury: 'none', bodyInjury: 'none', handsInjury: 'none', feetInjury: 'none', waistInjury: 'none' },
            { id: 'survivor-4', color: 'White', name: 'Survivor 4', survival: 0, insanity: 0, head: 0, body: 0, hands: 0, feet: 0, waist: 0, bleed: 0, maxBleed: 5, headInjury: 'none', bodyInjury: 'none', handsInjury: 'none', feetInjury: 'none', waistInjury: 'none' },
        ];

        const initialMonster = {
            name: 'White Lion',
            currentLife: 20,
            maxLife: 20
        };
        
        const initialGameState = {
            year: 1,
            survivors: initialSurvivors,
            monster: initialMonster
        };

        const renderSurvivors = (survivors) => {
            const container = document.getElementById('survivor-grid');
            if (!container) return;
            container.innerHTML = '';
            survivors.forEach(survivor => {
                const card = document.createElement('div');
                card.id = `card-${survivor.id}`;
                card.className = "bg-zinc-900 p-6 rounded-xl shadow-lg survivor-card";
                card.innerHTML = `
                    <p class="text-2xl font-bold mb-4 text-center text-gray-200">${survivor.color}: ${survivor.name}</p>
                    <div class="grid grid-cols-2 gap-y-3 gap-x-2 text-md text-gray-300">
                        <p>Survival: <span class="font-bold text-lg text-white" id="${survivor.id}-survival">${survivor.survival}</span></p>
                        <p>Insanity: <span class="font-bold text-lg text-white" id="${survivor.id}-insanity">${survivor.insanity}</span></p>
                        <p>Head: <span class="font-bold text-white" id="${survivor.id}-head">${survivor.head}</span><span id="${survivor.id}-head-injury" class="ml-2 text-red-400">${survivor.headInjury === 'low' ? 'L' : survivor.headInjury === 'high' ? 'H' : ''}</span></p>
                        <p>Body: <span class="font-bold text-white" id="${survivor.id}-body">${survivor.body}</span><span id="${survivor.id}-body-injury" class="ml-2 text-red-400">${survivor.bodyInjury === 'low' ? 'L' : survivor.bodyInjury === 'high' ? 'H' : ''}</span></p>
                        <p>Hands: <span class="font-bold text-white" id="${survivor.id}-hands">${survivor.hands}</span><span id="${survivor.id}-hands-injury" class="ml-2 text-red-400">${survivor.handsInjury === 'low' ? 'L' : survivor.handsInjury === 'high' ? 'H' : ''}</span></p>
                        <p>Feet: <span class="font-bold text-white" id="${survivor.id}-feet">${survivor.feet}</span><span id="${survivor.id}-feet-injury" class="ml-2 text-red-400">${survivor.feetInjury === 'low' ? 'L' : survivor.feetInjury === 'high' ? 'H' : ''}</span></p>
                        <p>Waist: <span class="font-bold text-white" id="${survivor.id}-waist">${survivor.waist}</span><span id="${survivor.id}-waist-injury" class="ml-2 text-red-400">${survivor.waistInjury === 'low' ? 'L' : survivor.waistInjury === 'high' ? 'H' : ''}</span></p>
                    </div>
                    <div class="mt-6">
                        <label class="text-md text-gray-400">Bleed: <span class="font-bold text-white" id="${survivor.id}-bleed-text">${survivor.bleed} / ${survivor.maxBleed}</span></label>
                        <div class="relative pt-2">
                            <div class="overflow-hidden h-4 flex rounded-full bg-zinc-800 border-2 border-zinc-700">
                                <div id="${survivor.id}-bleed-fill" style="width: ${survivor.bleed / survivor.maxBleed * 100}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-red-600 transition-all duration-300"></div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        };

        const renderMonster = (monster) => {
            const monsterName = document.getElementById('monster-name');
            const lifeText = document.getElementById('monster-life-text');
            const lifeFill = document.getElementById('monster-life-fill');
            
            if (!monsterName || !lifeText || !lifeFill) return;
            
            monsterName.textContent = monster.name;
            const lifePercentage = (monster.currentLife / monster.maxLife) * 100;
            lifeFill.style.width = `${Math.max(0, lifePercentage)}%`;
            lifeText.textContent = `${monster.currentLife} / ${monster.maxLife}`;
            lifeFill.classList.remove('bg-red-600', 'bg-amber-500', 'bg-emerald-500');
            if (lifePercentage > 50) {
                lifeFill.classList.add('bg-emerald-500');
            } else if (lifePercentage > 25) {
                lifeFill.classList.add('bg-amber-500');
            } else {
                lifeFill.classList.add('bg-red-600');
            }
        };

        const renderControlPanel = (gameState) => {
            const controlsContainer = document.getElementById('survivor-controls');
            if (!controlsContainer) return;
            controlsContainer.innerHTML = '';
            
            const yearInput = document.getElementById('year-input');
            const monsterNameInput = document.getElementById('monster-name-input');
            const monsterLifeInput = document.getElementById('monster-life-input');
            const monsterMaxLifeInput = document.getElementById('monster-max-life-input');
            
            if (yearInput) yearInput.value = gameState.year;
            if (monsterNameInput) monsterNameInput.value = gameState.monster.name;
            if (monsterLifeInput) monsterLifeInput.value = gameState.monster.currentLife;
            if (monsterMaxLifeInput) monsterMaxLifeInput.value = gameState.monster.maxLife;

            gameState.survivors.forEach(survivor => {
                const survivorDiv = document.createElement('div');
                survivorDiv.className = "mb-4 border-b-2 border-gray-700 pb-4";
                survivorDiv.innerHTML = `<label for="${survivor.id}-name-input" class="block text-gray-300 font-semibold mb-2">${survivor.color} Survivor Name</label>
                    <input id="${survivor.id}-name-input" type="text" value="${survivor.name}" class="w-full p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                `;
                controlsContainer.appendChild(survivorDiv);
                
                const statContainer = document.createElement('div');
                statContainer.className = "grid grid-cols-2 gap-4 mt-4";
                
                const stats = ['survival', 'insanity', 'head', 'body', 'hands', 'feet', 'waist', 'bleed', 'maxBleed'];
                const injuryParts = ['head', 'body', 'hands', 'feet', 'waist'];

                stats.forEach(stat => {
                    const isInjuryPart = injuryParts.includes(stat);
                    const isMaxBleed = stat === 'maxBleed';
                    let labelText = stat.replace(/([A-Z])/g, ' $1').trim();
                    if (isMaxBleed) labelText = 'Max Bleed';

                    statContainer.innerHTML += `
                        <div class="flex items-center">
                            <label for="${survivor.id}-${stat}-input" class="block text-gray-300 font-semibold text-sm capitalize flex-grow">${labelText}</label>
                            <input id="${survivor.id}-${stat}-input" type="number" value="${survivor[stat]}" class="stat-input p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            ${isInjuryPart ? `<span id="${survivor.id}-${stat}-injury-toggle" data-survivor-id="${survivor.id}" data-part="${stat}" class="injury-toggle">${survivor[`${stat}Injury`] === 'low' ? 'L' : survivor[`${stat}Injury`] === 'high' ? 'H' : ''}</span>` : ''}
                        </div>
                    `;
                });
                survivorDiv.appendChild(statContainer);
            });
        };

        const initDataListener = () => {
            const gameStateRef = getGameStateRef();
            if (!gameStateRef) {
                fallbackToLocalMode();
                return;
            }
            
            const unsubscribe = onSnapshot(gameStateRef, async (doc) => {
                if (doc.exists()) {
                    const fetchedState = doc.data();
                    const updatedSurvivors = initialSurvivors.map(initialSurvivor => {
                        const fetchedSurvivor = fetchedState.survivors.find(s => s.id === initialSurvivor.id) || {};
                        return { ...initialSurvivor, ...fetchedSurvivor };
                    });
                    
                    currentGameState = {
                        ...initialGameState,
                        ...fetchedState,
                        survivors: updatedSurvivors
                    };

                    updateUI(currentGameState);
                    hideLoadingOverlay();
                } else {
                    currentGameState = initialGameState;
                    await setDoc(gameStateRef, initialGameState);
                    hideLoadingOverlay();
                }
            }, (error) => {
                console.error("Error listening to document:", error);
                showMessageBox("Error loading data from Firestore. Check console for details.", 'error');
                unsubscribe();
                fallbackToLocalMode();
            });
        };

        const updateUI = (gameState) => {
            const gameYear = document.getElementById('game-year');
            if (gameYear) {
                gameYear.textContent = `Lantern Year: ${gameState.year}`;
            }
            renderMonster(gameState.monster);
            renderSurvivors(gameState.survivors);
        };

        const controlPanel = document.getElementById('control-panel');
        const mainOverlay = document.getElementById('main-overlay');

        const toggleControlPanel = () => {
            if (!controlPanel) return;
            const isVisible = controlPanel.classList.toggle('is-visible');
            if (isVisible) {
                renderControlPanel(currentGameState);
            }
        };

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                toggleControlPanel();
            }
        });

        const closeBtn = document.getElementById('close-btn');
        if (closeBtn) {
            closeBtn.addEventListener('click', toggleControlPanel);
        }

        if (controlPanel) {
            controlPanel.addEventListener('click', async (e) => {
                if (!currentGameState) return;

                const toggle = e.target.closest('.injury-toggle');
                if (toggle) {
                    const survivorId = toggle.dataset.survivorId;
                    const part = toggle.dataset.part;
                    const injuryProp = `${part}Injury`;
                    
                    const survivorIndex = currentGameState.survivors.findIndex(s => s.id === survivorId);
                    if (survivorIndex !== -1) {
                        const currentInjury = currentGameState.survivors[survivorIndex][injuryProp];
                        let newInjury = 'none';
                        if (currentInjury === 'none') {
                            newInjury = 'low';
                        } else if (currentInjury === 'low') {
                            newInjury = 'high';
                        }
                        currentGameState.survivors[survivorIndex][injuryProp] = newInjury;
                    }
                    
                    updateUI(currentGameState);

                    if (isConnected) {
                        const gameStateRef = getGameStateRef();
                        try {
                            await setDoc(gameStateRef, currentGameState);
                            showMessageBox("Game state saved to Firestore.");
                        } catch (error) {
                            console.error("Error updating document:", error);
                            showMessageBox("Error saving data to Firestore. Check console.", 'error');
                        }
                    } else {
                        console.log("Running in local mode. Data not saved to Firestore.");
                    }
                }
            });

            controlPanel.addEventListener('input', async (e) => {
                if (!currentGameState) return;

                const fieldId = e.target.id;
                let value = e.target.type === 'number' ? parseInt(e.target.value, 10) : e.target.value;
                
                if (e.target.type === 'number' && isNaN(value)) {
                    value = 0;
                }
                
                if (fieldId === 'year-input') {
                    currentGameState.year = value;
                }
                else if (fieldId === 'monster-name-input') {
                    currentGameState.monster.name = value;
                }
                else if (fieldId === 'monster-life-input') {
                    currentGameState.monster.currentLife = value;
                } else if (fieldId === 'monster-max-life-input') {
                    currentGameState.monster.maxLife = value;
                }
                else if (fieldId.startsWith('survivor-') && fieldId.endsWith('-input')) {
                    const parts = fieldId.split('-');
                    const statName = parts[parts.length - 2];
                    const survivorId = parts.slice(0, -2).join('-');
                    const survivorIndex = currentGameState.survivors.findIndex(s => s.id === survivorId);
                    if (survivorIndex !== -1) {
                        currentGameState.survivors[survivorIndex][statName] = value;
                    }
                }
                
                updateUI(currentGameState);

                if (isConnected) {
                    const gameStateRef = getGameStateRef();
                    try {
                        await setDoc(gameStateRef, currentGameState);
                        showMessageBox("Game state saved to Firestore.");
                    } catch (error) {
                        console.error("Error saving document:", error);
                        showMessageBox("Error saving data to Firestore. Check console.", 'error');
                    }
                } else {
                    console.log("Running in local mode. Data not saved to Firestore.");
                }
            });
        }
        

        window.onload = setupFirebase;
    </script>
</body>
</html>
