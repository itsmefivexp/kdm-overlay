<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDM Stream Overlay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            color: #f3f4f6;
            background: transparent;
            backdrop-filter: none;
        }
        .container {
            border: none;
            background: transparent;
            box-shadow: none;
            position: relative;
        }
        .stat-bar {
            background-color: #374151;
            border: 1px solid #4b5563;
        }
        .stat-fill {
            transition: width 0.3s ease-in-out;
        }
        /* Updated survivor section to use flexbox for a horizontal layout */
        .survivor-section {
            display: flex;
            gap: 1rem;
        }
        .survivor-card {
            flex-basis: 20%;
            flex-shrink: 0;
            min-width: 200px;
        }
        .stat-input {
            width: 4rem;
            text-align: center;
        }
        .control-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background: rgba(17, 24, 39, 0.95);
            border: 2px solid #4b5563;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.9);
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .control-panel.is-visible {
            visibility: visible;
            opacity: 1;
        }
        .monster-stats {
            min-height: 120px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .injury-toggle {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            line-height: 1.5rem;
            text-align: center;
            border: 1px solid #4b5563;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            margin-left: 0.5rem;
        }
        .injury-low {
            background-color: #fca5a5;
            color: #7f1d1d;
        }
        .injury-high {
            background-color: #b91c1c;
            color: white;
        }
        .floating-button {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 50;
            padding: 1rem 1.5rem;
            background: #b91c1c; /* A strong red */
            color: white;
            border-radius: 9999px;
            font-weight: bold;
            box-shadow: 0 10px 15px rgba(0,0,0,0.5);
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
            cursor: pointer;
        }
        .floating-button:hover {
            background-color: #991b1b; /* Darker red on hover */
            transform: scale(1.05);
        }
        /* New CSS for plus/minus buttons */
        .plus-minus-btn {
            background-color: #4b5563;
            color: #d1d5db;
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.25rem;
            line-height: 1;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .plus-minus-btn:hover {
            background-color: #6b7280;
        }
        
        .text-outline-white {
            color: black;
            text-shadow:
                -1px -1px 0 #fff,
                1px -1px 0 #fff,
                -1px 1px 0 #fff,
                1px 1px 0 #fff;
        }
        
    </style>
</head>
<body class="p-8 md:p-16 flex items-center justify-center min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Main Overlay Container -->
    <div id="main-overlay" class="container w-full max-w-screen-2xl mx-auto rounded-lg p-6 md:p-10">

        <!-- Main stats container with new horizontal layout -->
        <main class="flex flex-col sm:flex-row flex-wrap gap-6 justify-center">
            
            <!-- Settlement/Year section on a single line -->
            <div class="w-full flex items-center gap-4 border-b border-gray-600 pb-2 mb-4">
                <div class="flex items-center gap-2 flex-grow">
                    <label for="settlement-name-display" class="text-2xl font-bold text-outline-white">Settlement:</label>
                    <input id="settlement-name-display" type="text" class="text-xl bg-transparent flex-grow text-left font-semibold text-outline-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <h2 id="lantern-year-heading" class="text-2xl font-bold text-outline-white whitespace-nowrap"></h2>
            </div>
            
            <!-- Survivor and Monster cards -->
            <div id="game-cards" class="flex gap-6 justify-start overflow-x-auto whitespace-nowrap w-full">
                <!-- Survivor cards will be dynamically inserted here -->
                <div id="survivor-grid" class="survivor-section">
                    <!-- Monster Card -->
                    <div id="monster-card" class="bg-gray-800 p-4 rounded-lg survivor-card">
                        <p class="text-xl font-bold mb-2"><span id="monster-name">White Lion</span></p>
                        <div class="mb-2">
                            <label class="text-sm text-gray-400" for="monster-life">Life</label>
                            <div class="relative pt-1">
                                <div class="overflow-hidden h-4 text-xs flex rounded bg-red-800">
                                    <div id="monster-life-fill" style="width: 100%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-red-500 transition-all duration-300"></div>
                                </div>
                            </div>
                            <p id="monster-life-text" class="text-sm text-right mt-1">20 / 20</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- General info and Footer -->
        <footer class="text-center mt-6 text-gray-500 text-sm">
            <p>Overlay powered by Firestore. Press <kbd>Esc</kbd> to toggle controls.</p>
        </footer>
    </div>

    <!-- Control Panel -->
    <div id="control-panel" class="control-panel w-full max-w-lg p-8 rounded-lg">
        <h2 class="text-3xl font-bold mb-4 text-center">Control Panel</h2>

        <!-- Warning message for local mode -->
        <div id="local-mode-warning" class="hidden bg-yellow-900 text-yellow-200 p-3 rounded-md mb-4 text-center text-sm">
            Not connected to Firestore. Your changes will not be saved.
        </div>

        <!-- General Game Info Controls -->
        <div class="mb-6 border-b border-gray-700 pb-4">
            <label for="year-input" class="block text-gray-300 font-semibold mb-2">Game Year</label>
            <input id="year-input" type="number" min="1" class="w-full p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <label for="settlement-name-input" class="block text-gray-300 font-semibold mb-2">Settlement Name</label>
            <input id="settlement-name-input" type="text" class="w-full p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>

        <!-- Monster Controls -->
        <div class="mb-6 border-b border-gray-700 pb-4">
            <h3 class="text-xl font-bold mb-2">Monster Stats</h3>
            <div class="mb-2 flex items-center gap-2">
                <label for="monster-name-input" class="block text-gray-300 font-semibold flex-grow">Monster Name</label>
                <input id="monster-name-input" type="text" class="w-full p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="mb-2 flex items-center gap-2">
                <label for="monster-life-input" class="block text-gray-300 font-semibold flex-grow">Current Life</label>
                <input id="monster-life-input" type="number" min="0" class="stat-input p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button class="plus-minus-btn" data-target="monster-life-input" data-op="minus">-</button>
                <button class="plus-minus-btn" data-target="monster-life-input" data-op="plus">+</button>
            </div>
            <div class="mb-2 flex items-center gap-2">
                <label for="monster-max-life-input" class="block text-gray-300 font-semibold flex-grow">Max Life</label>
                <input id="monster-max-life-input" type="number" min="1" class="stat-input p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-ring-indigo-500">
                <button class="plus-minus-btn" data-target="monster-max-life-input" data-op="minus">-</button>
                <button class="plus-minus-btn" data-target="monster-max-life-input" data-op="plus">+</button>
            </div>
        </div>

        <!-- Survivor Controls -->
        <div id="survivor-controls" class="space-y-4">
            <h3 class="text-xl font-bold mb-2">Survivor Stats</h3>
            <!-- Survivor input fields will be dynamically added here -->
        </div>

        <button id="close-btn" class="mt-6 w-full py-2 bg-red-600 text-white rounded-md font-bold hover:bg-red-700 transition duration-200">Close</button>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed bottom-4 left-4 p-4 bg-gray-800 text-white rounded-lg shadow-lg hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBZWJ-41VDkBrfwoup1TfBeG_eCh6wDfJk",
            authDomain: "kdm-overlay-partduex.firebaseapp.com",
            projectId: "kdm-overlay-partduex",
            storageBucket: "kdm-overlay-partduex.firebasestorage.app",
            messagingSenderId: "975715726701",
            appId: "1:975715726701:web:08f846b03d19603e85d664",
            measurementId: "G-1GNQXZD29F"
            };

        let app = null;
        let db = null;
        let currentGameState = null;
        let isConnected = false;
        
        const showMessageBox = (message, type = 'info') => {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = `fixed bottom-4 left-4 p-4 rounded-lg shadow-lg block z-50 transition-all duration-300 ease-in-out`;
            if (type === 'error') {
                messageBox.classList.add('bg-red-800', 'text-white');
            } else {
                messageBox.classList.add('bg-gray-800', 'text-white');
            }
            setTimeout(() => {
                messageBox.classList.remove('block');
                messageBox.classList.add('hidden');
            }, 3000);
        };

        const hideLoadingOverlay = () => {
            document.getElementById('loading-overlay').style.display = 'none';
        };

        const setupFirebase = () => {
            // Check if all necessary Firebase config fields have been provided
            const isConfigValid = Object.values(firebaseConfig).every(val => typeof val === 'string' && val.length > 0 && !val.includes('YOUR_'));
            
            if (isConfigValid) {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    isConnected = true;
                    initDataListener();
                    console.log("Successfully connected to Firestore.");
                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    showMessageBox("Connection failed. Check console for details.", 'error');
                    fallbackToLocalMode();
                }
            } else {
                console.warn("Firebase configuration is incomplete. Running in local mode.");
                showMessageBox("Please add your Firebase config to the code.", 'error');
                fallbackToLocalMode();
            }
        };

        const fallbackToLocalMode = () => {
            currentGameState = initialGameState;
            updateUI(currentGameState);
            hideLoadingOverlay();
            isConnected = false;
            document.getElementById('local-mode-warning').classList.remove('hidden');
        };
        
        // This function now points to a public, shared location
        const getGameStateRef = () => {
            if (!db) {
                return null;
            }
            // Use a hardcoded path for public access
            return doc(db, 'kdm_stats/game_state');
        };

        const initialSurvivors = [
            { id: 'survivor-1', color: 'Blue', name: 'Survivor 1', survival: 0, insanity: 0, head: 0, body: 0, arms: 0, feet: 0, waist: 0, bleed: 0, maxBleed: 5, headInjury: 'none', bodyInjury: 'none', armsInjury: 'none', feetInjury: 'none', waistInjury: 'none' },
            { id: 'survivor-2', color: 'Red', name: 'Survivor 2', survival: 0, insanity: 0, head: 0, body: 0, arms: 0, feet: 0, waist: 0, bleed: 0, maxBleed: 5, headInjury: 'none', bodyInjury: 'none', armsInjury: 'none', feetInjury: 'none', waistInjury: 'none' },
            { id: 'survivor-3', color: 'Green', name: 'Survivor 3', survival: 0, insanity: 0, head: 0, body: 0, arms: 0, feet: 0, waist: 0, bleed: 0, maxBleed: 5, headInjury: 'none', bodyInjury: 'none', armsInjury: 'none', feetInjury: 'none', waistInjury: 'none' },
            { id: 'survivor-4', color: 'White', name: 'Survivor 4', survival: 0, insanity: 0, head: 0, body: 0, arms: 0, feet: 0, waist: 0, bleed: 0, maxBleed: 5, headInjury: 'none', bodyInjury: 'none', armsInjury: 'none', feetInjury: 'none', waistInjury: 'none' },
        ];

        const initialMonster = {
            name: 'White Lion',
            currentLife: 20,
            maxLife: 20
        };
        
        const initialGameState = {
            year: 1,
            settlementName: 'The Settlement',
            survivors: initialSurvivors,
            monster: initialMonster
        };

        const renderSurvivors = (survivors) => {
            const container = document.getElementById('survivor-grid');
            // Remove existing survivor cards, but keep the monster card
            const monsterCard = document.getElementById('monster-card');
            container.innerHTML = '';
            if (monsterCard) {
                container.appendChild(monsterCard);
            }
            survivors.forEach(survivor => {
                const card = document.createElement('div');
                card.id = `card-${survivor.id}`;
                card.className = "bg-gray-800 p-4 rounded-lg survivor-card";

                // Death Overlay logic
                const deathOverlayClass = survivor.isDead ? 'opacity-100 visible' : 'opacity-0 invisible';
                const deathOverlay = `
                    <div id="${survivor.id}-death-overlay" class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center rounded-lg ${deathOverlayClass} transition-opacity duration-300">
                        <!-- Using a strong red color and bold text for visual impact -->
                        <span class="text-4xl font-black text-red-600 tracking-widest text-outline-white transform rotate-6">DECEASED</span>
                    </div>
                `;
                
                card.innerHTML = `
                    <p class="text-xl font-bold mb-2">${survivor.color}: ${survivor.name}</p>
                    <div class="grid grid-cols-3 gap-2 text-sm text-gray-300">
                        <p>Survival: <span id="${survivor.id}-survival">${survivor.survival}</span></p>
                        <p>Insanity: <span id="${survivor.id}-insanity">${survivor.insanity}</span></p>
                        <p></p>
                        <p>Head: <span id="${survivor.id}-head">${survivor.head}</span><span id="${survivor.id}-head-injury" class="ml-2 text-red-400">${survivor.headInjury === 'low' ? 'L' : survivor.headInjury === 'high' ? 'H' : ''}</span></p>
                        <p>Body: <span id="${survivor.id}-body">${survivor.body}</span><span id="${survivor.id}-body-injury" class="ml-2 text-red-400">${survivor.bodyInjury === 'low' ? 'L' : survivor.bodyInjury === 'high' ? 'H' : ''}</span></p>
                        <p>Arms: <span id="${survivor.id}-arms">${survivor.arms}</span><span id="${survivor.id}-arms-injury" class="ml-2 text-red-400">${survivor.armsInjury === 'low' ? 'L' : survivor.armsInjury === 'high' ? 'H' : ''}</span></p>
                        <p>Feet: <span id="${survivor.id}-feet">${survivor.feet}</span><span id="${survivor.id}-feet-injury" class="ml-2 text-red-400">${survivor.feetInjury === 'low' ? 'L' : survivor.feetInjury === 'high' ? 'H' : ''}</span></p>
                        <p>Waist: <span id="${survivor.id}-waist">${survivor.waist}</span><span id="${survivor.id}-waist-injury" class="ml-2 text-red-400">${survivor.waistInjury === 'low' ? 'L' : survivor.waistInjury === 'high' ? 'H' : ''}</span></p>
                    </div>
                    <div class="mt-4">
                        <label class="text-sm text-gray-400">Bleed: <span id="${survivor.id}-bleed-text">${survivor.bleed} / ${survivor.maxBleed}</span></label>
                        <div class="relative pt-1">
                            <div class="overflow-hidden h-3 flex text-xs rounded bg-gray-600">
                                <div id="${survivor.id}-bleed-fill" style="width: ${survivor.bleed / survivor.maxBleed * 100}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-red-500 transition-all duration-300"></div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        };

        const renderMonster = (monster) => {
            document.getElementById('monster-name').textContent = monster.name;
            const lifeText = document.getElementById('monster-life-text');
            const lifeFill = document.getElementById('monster-life-fill');
            
            const lifePercentage = (monster.currentLife / monster.maxLife) * 100;
            lifeFill.style.width = `${Math.max(0, lifePercentage)}%`;
            lifeText.textContent = `${monster.currentLife} / ${monster.maxLife}`;
            lifeFill.classList.remove('bg-red-500', 'bg-yellow-500', 'bg-green-500');
            if (lifePercentage > 50) {
                lifeFill.classList.add('bg-green-500');
            } else if (lifePercentage > 25) {
                lifeFill.classList.add('bg-yellow-500');
            } else {
                lifeFill.classList.add('bg-red-500');
            }
        };

        const renderControlPanel = (gameState) => {
            const controlsContainer = document.getElementById('survivor-controls');
            controlsContainer.innerHTML = '';
            
            document.getElementById('year-input').value = gameState.year;
            document.getElementById('settlement-name-input').value = gameState.settlementName;
            document.getElementById('monster-name-input').value = gameState.monster.name;
            document.getElementById('monster-life-input').value = gameState.monster.currentLife;
            document.getElementById('monster-max-life-input').value = gameState.monster.maxLife;

            gameState.survivors.forEach(survivor => {
                const survivorDiv = document.createElement('div');
                survivorDiv.className = "mb-4 border-b border-gray-700 pb-2";

                // Added Deceased Checkbox Control
                const deceasedControl = `
                    <div class="flex items-center justify-between mb-2">
                        <label for="${survivor.id}-is-dead-input" class="text-red-400 font-bold flex-grow mr-4">Survivor Deceased?</label>
                        <input id="${survivor.id}-is-dead-input" type="checkbox" ${survivor.isDead ? 'checked' : ''} 
                               class="h-6 w-6 rounded text-red-600 bg-gray-700 border-gray-600 focus:ring-red-500" 
                               data-survivor-id="${survivor.id}">
                    </div>
                `;
                
                survivorDiv.innerHTML = `<label for="${survivor.id}-name-input" class="block text-gray-300 font-semibold mb-2">${survivor.color} Survivor Name</label>
                    <input id="${survivor.id}-name-input" type="text" value="${survivor.name}" class="w-full p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    ${deceasedControl}
                `;
                controlsContainer.appendChild(survivorDiv);
                
                const statContainer = document.createElement('div');
                statContainer.className = "grid grid-cols-2 gap-4 mt-2";
                
                const stats = ['survival', 'insanity', 'head', 'body', 'arms', 'feet', 'waist', 'bleed', 'maxBleed'];
                const injuryParts = ['head', 'body', 'arms', 'feet', 'waist'];

                stats.forEach(stat => {
                    const isInjuryPart = injuryParts.includes(stat);
                    const isMaxBleed = stat === 'maxBleed';
                    let labelText = stat.replace(/([A-Z])/g, ' $1').trim();
                    if (isMaxBleed) labelText = 'Max Bleed';
                    const hasButtons = !['name', 'maxBleed'].includes(stat);
                    
                    statContainer.innerHTML += `
                        <div class="flex items-center gap-2">
                            <label for="${survivor.id}-${stat}-input" class="block text-gray-300 font-semibold text-sm capitalize flex-grow">${labelText}</label>
                            <input id="${survivor.id}-${stat}-input" type="number" value="${survivor[stat]}" class="stat-input p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            ${hasButtons ? `
                                <button class="plus-minus-btn" data-target="${survivor.id}-${stat}-input" data-op="minus">-</button>
                                <button class="plus-minus-btn" data-target="${survivor.id}-${stat}-input" data-op="plus">+</button>
                            ` : ''}
                            ${isInjuryPart ? `<span id="${survivor.id}-${stat}-injury-toggle" data-survivor-id="${survivor.id}" data-part="${stat}" class="injury-toggle ml-2">${survivor[`${stat}Injury`] === 'low' ? 'L' : survivor[`${stat}Injury`] === 'high' ? 'H' : ''}</span>` : ''}
                        </div>
                    `;
                });
                survivorDiv.appendChild(statContainer);
            });
        };

        const initDataListener = () => {
            const gameStateRef = getGameStateRef();
            if (!gameStateRef) {
                fallbackToLocalMode();
                return;
            }
            
            const unsubscribe = onSnapshot(gameStateRef, async (doc) => {
                if (doc.exists()) {
                    const fetchedState = doc.data();
                    const updatedSurvivors = initialSurvivors.map(initialSurvivor => {
                        const fetchedSurvivor = fetchedState.survivors.find(s => s.id === initialSurvivor.id) || {};
                        return { ...initialSurvivor, ...fetchedSurvivor };
                    });
                    
                    currentGameState = {
                        ...initialGameState,
                        ...fetchedState,
                        survivors: updatedSurvivors
                    };

                    updateUI(currentGameState);
                    hideLoadingOverlay();
                } else {
                    currentGameState = initialGameState;
                    await setDoc(gameStateRef, initialGameState);
                    hideLoadingOverlay();
                }
            }, (error) => {
                console.error("Error listening to document:", error);
                showMessageBox("Error loading data from Firestore. Check console for details.", 'error');
                unsubscribe();
                fallbackToLocalMode();
            });
        };

        const updateUI = (gameState) => {
            document.getElementById('lantern-year-heading').textContent = `Lantern Year: ${gameState.year}`;
            document.getElementById('settlement-name-display').value = gameState.settlementName;
            renderMonster(gameState.monster);
            renderSurvivors(gameState.survivors);
        };

        const controlPanel = document.getElementById('control-panel');
        const mainOverlay = document.getElementById('main-overlay');

        const toggleControlPanel = () => {
            const isVisible = controlPanel.classList.toggle('is-visible');
            mainOverlay.classList.toggle('blur-sm');

            if (isVisible) {
                renderControlPanel(currentGameState);
            }
        };
        // Event listener for the new button
        const toggleControlBtn = document.getElementById('toggle-control-btn');
        if (toggleControlBtn) {
            toggleControlBtn.addEventListener('click', toggleControlPanel);
        }
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                toggleControlPanel();
            }
        });

        document.getElementById('close-btn').addEventListener('click', toggleControlPanel);
        
        // New listener to handle plus/minus button clicks
        controlPanel.addEventListener('click', async (e) => {
            const button = e.target.closest('.plus-minus-btn');
            if (button) {
                const targetId = button.dataset.target;
                const operation = button.dataset.op;
                const input = document.getElementById(targetId);

                if (input && input.type === 'number') {
                    let value = parseInt(input.value, 10);
                    if (isNaN(value)) {
                        value = 0;
                    }

                    if (operation === 'plus') {
                        value++;
                    } else if (operation === 'minus') {
                        value--;
                    }
                    
                    input.value = value;
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
        });

        // NEW: Listener for the Deceased checkbox changes
        controlPanel.addEventListener('change', async (e) => {
            if (!currentGameState) return;

            const checkbox = e.target;
            if (checkbox.type === 'checkbox' && checkbox.id.endsWith('-is-dead-input')) {
                const survivorId = checkbox.dataset.survivorId;
                const isDead = checkbox.checked;

                const survivorIndex = currentGameState.survivors.findIndex(s => s.id === survivorId);
                if (survivorIndex !== -1) {
                    currentGameState.survivors[survivorIndex].isDead = isDead;
                }

                updateUI(currentGameState); // Update UI immediately to show/hide overlay

                if (isConnected) {
                    const gameStateRef = getGameStateRef();
                    try {
                        await setDoc(gameStateRef, currentGameState);
                        showMessageBox("Game state saved to Firestore.");
                    } catch (error) {
                        console.error("Error saving document:", error);
                        showMessageBox("Error saving data to Firestore. Check console.", 'error');
                    }
                } else {
                    console.log("Running in local mode. Data not saved to Firestore.");
                }
            }
        });

        controlPanel.addEventListener('click', async (e) => {
            if (!currentGameState) return;

            const toggle = e.target.closest('.injury-toggle');
            if (toggle) {
                const survivorId = toggle.dataset.survivorId;
                const part = toggle.dataset.part;
                const injuryProp = `${part}Injury`;
                
                const survivorIndex = currentGameState.survivors.findIndex(s => s.id === survivorId);
                if (survivorIndex !== -1) {
                    const currentInjury = currentGameState.survivors[survivorIndex][injuryProp];
                    let newInjury = 'none';
                    if (currentInjury === 'none') {
                        newInjury = 'low';
                    } else if (currentInjury === 'low') {
                        newInjury = 'high';
                    }
                    currentGameState.survivors[survivorIndex][injuryProp] = newInjury;
                }
                
                updateUI(currentGameState);

                if (isConnected) {
                    const gameStateRef = getGameStateRef();
                    try {
                        await setDoc(gameStateRef, currentGameState);
                        showMessageBox("Game state saved to Firestore.");
                    } catch (error) {
                        console.error("Error updating document:", error);
                        showMessageBox("Error saving data to Firestore. Check console.", 'error');
                    }
                } else {
                    console.log("Running in local mode. Data not saved to Firestore.");
                }
            }
        });

        controlPanel.addEventListener('input', async (e) => {
            if (!currentGameState) return;

            const fieldId = e.target.id;
            let value = e.target.type === 'number' ? parseInt(e.target.value, 10) : e.target.value;
            
            if (e.target.type === 'number' && isNaN(value)) {
                value = 0;
            }
            
            if (fieldId === 'year-input') {
                currentGameState.year = value;
            }
            else if (fieldId === 'settlement-name-input') {
                currentGameState.settlementName = value;
            }
            else if (fieldId === 'monster-name-input') {
                currentGameState.monster.name = value;
            }
            else if (fieldId === 'monster-life-input') {
                currentGameState.monster.currentLife = value;
            } else if (fieldId === 'monster-max-life-input') {
                currentGameState.monster.maxLife = value;
            }
            else if (fieldId.startsWith('survivor-') && fieldId.endsWith('-input')) {
                const parts = fieldId.split('-');
                const statName = parts[parts.length - 2];
                const survivorId = parts.slice(0, -2).join('-');
                const survivorIndex = currentGameState.survivors.findIndex(s => s.id === survivorId);
                if (survivorIndex !== -1) {
                    currentGameState.survivors[survivorIndex][statName] = value;
                }
            }
            
            updateUI(currentGameState);

            if (isConnected) {
                const gameStateRef = getGameStateRef();
                try {
                    await setDoc(gameStateRef, currentGameState);
                    showMessageBox("Game state saved to Firestore.");
                } catch (error) {
                    console.error("Error saving document:", error);
                    showMessageBox("Error saving data to Firestore. Check console.", 'error');
                }
            } else {
                console.log("Running in local mode. Data not saved to Firestore.");
            }
        });

        document.getElementById('settlement-name-display').addEventListener('input', async (e) => {
            if (!currentGameState) return;
            currentGameState.settlementName = e.target.value;

            if (isConnected) {
                const gameStateRef = getGameStateRef();
                try {
                    await setDoc(gameStateRef, currentGameState);
                    showMessageBox("Game state saved to Firestore.");
                } catch (error) {
                    console.error("Error saving document:", error);
                    showMessageBox("Error saving data to Firestore. Check console.", 'error');
                }
            } else {
                console.log("Running in local mode. Data not saved to Firestore.");
            }
        });

        window.onload = setupFirebase;
    </script>
    <!-- Controls Button for Mobile/Tablet -->
    <button id="toggle-control-btn" class="floating-button">
        Controls
    </button>
</body>
</html>

