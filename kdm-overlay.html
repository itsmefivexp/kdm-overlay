<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDM Stream Overlay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Uncial Antiqua', serif;
            color: #f3f4f6;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(1px);
        }
        .container {
            border: 2px solid #555;
            background: rgba(0, 0, 0, 0.6);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
            position: relative;
        }
        .stat-bar {
            background-color: #374151;
            border: 1px solid #4b5563;
        }
        .stat-fill {
            transition: width 0.3s ease-in-out;
        }
        .survivor-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        @media (max-width: 768px) {
            .survivor-section {
                grid-template-columns: 1fr;
            }
        }
        .stat-input {
            width: 4rem;
            text-align: center;
        }
        /* New styling for the control panel */
        .control-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background: rgba(17, 24, 39, 0.95);
            border: 2px solid #4b5563;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.9);
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            /* Added to make the panel fit the screen and be scrollable */
            width: 90%;
            max-width: 500px;
            max-height: 90vh; /* Set a max height */
            overflow-y: auto; /* Enable vertical scrolling */
        }
        .control-panel.is-visible {
            visibility: visible;
            opacity: 1;
        }
        .monster-stats {
            min-height: 120px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .injury-toggle {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            line-height: 1.5rem;
            text-align: center;
            border: 1px solid #4b5563;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            margin-left: 0.5rem;
        }
        .injury-low {
            background-color: #fca5a5; /* Red-300 */
            color: #7f1d1d; /* Red-900 */
        }
        .injury-high {
            background-color: #b91c1c; /* Red-700 */
            color: white;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Main Overlay Container -->
    <div id="main-overlay" class="container w-full max-w-7xl mx-auto rounded-lg p-6 md:p-10">

        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-5xl font-bold mb-2 tracking-wide">Kingdom Death: Monster</h1>
            <p id="game-year" class="text-xl md:text-2xl font-semibold text-gray-400">Lantern Year: 1</p>
        </header>

        <!-- Survivor and Monster Stats -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Survivor Stats Section -->
            <section id="survivor-stats" class="lg:col-span-2 space-y-4">
                <h2 class="text-2xl font-bold border-b border-gray-600 pb-2">Survivors</h2>
                <div id="survivor-grid" class="survivor-section">
                    <!-- Survivor cards will be dynamically inserted here -->
                </div>
            </section>

            <!-- Monster Stats Section -->
            <section id="monster-stats" class="lg:col-span-1">
                <h2 class="text-2xl font-bold border-b border-gray-600 pb-2">Monster</h2>
                <div id="monster-card" class="bg-gray-800 p-4 rounded-lg monster-stats">
                    <p class="text-xl font-bold mb-2"><span id="monster-name">White Lion</span></p>
                    <div class="mb-2">
                        <label class="text-sm text-gray-400" for="monster-life">Life</label>
                        <div class="relative pt-1">
                            <div class="overflow-hidden h-4 text-xs flex rounded bg-red-800">
                                <div id="monster-life-fill" style="width: 100%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-red-500 transition-all duration-300"></div>
                            </div>
                        </div>
                        <p id="monster-life-text" class="text-sm text-right mt-1">20 / 20</p>
                    </div>
                </div>
            </section>

        </main>

        <!-- General info and Footer -->
        <footer class="text-center mt-6 text-gray-500 text-sm">
            <p>Overlay powered by Firestore. Press <kbd>Esc</kbd> to toggle controls.</p>
            <p>Your User ID: <span id="user-id"></span></p>
        </footer>
    </div>

    <!-- Control Panel -->
    <div id="control-panel" class="control-panel w-full max-w-lg p-8 rounded-lg">
        <h2 class="text-3xl font-bold mb-4 text-center">Control Panel</h2>

        <!-- General Game Info Controls -->
        <div class="mb-6 border-b border-gray-700 pb-4">
            <label for="year-input" class="block text-gray-300 font-semibold mb-2">Game Year</label>
            <input id="year-input" type="number" min="1" class="w-full p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>

        <!-- Monster Controls -->
        <div class="mb-6 border-b border-gray-700 pb-4">
            <h3 class="text-xl font-bold mb-2">Monster Stats</h3>
            <div class="mb-2">
                <label for="monster-name-input" class="block text-gray-300 font-semibold mb-1">Monster Name</label>
                <input id="monster-name-input" type="text" class="w-full p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="mb-2">
                <label for="monster-life-input" class="block text-gray-300 font-semibold mb-1">Current Life</label>
                <input id="monster-life-input" type="number" min="0" class="w-full p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div>
                <label for="monster-max-life-input" class="block text-gray-300 font-semibold mb-1">Max Life</label>
                <input id="monster-max-life-input" type="number" min="1" class="w-full p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
        </div>

        <!-- Survivor Controls -->
        <div id="survivor-controls" class="space-y-4">
            <h3 class="text-xl font-bold mb-2">Survivor Stats</h3>
            <!-- Survivor input fields will be dynamically added here -->
        </div>

        <button id="close-btn" class="mt-6 w-full py-2 bg-red-600 text-white rounded-md font-bold hover:bg-red-700 transition duration-200">Close</button>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed bottom-4 left-4 p-4 bg-gray-800 text-white rounded-lg shadow-lg hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Setup ---
        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        let currentGameState = null; // Centralized state variable
        let isInitialized = false;

        const showMessageBox = (message, type = 'info') => {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = `fixed bottom-4 left-4 p-4 rounded-lg shadow-lg block z-50 transition-all duration-300 ease-in-out`;
            if (type === 'error') {
                messageBox.classList.add('bg-red-800', 'text-white');
            } else {
                messageBox.classList.add('bg-gray-800', 'text-white');
            }
            setTimeout(() => {
                messageBox.classList.remove('block');
                messageBox.classList.add('hidden');
            }, 3000);
        };

        const setupFirebase = async () => {
            try {
                if (typeof __firebase_config !== 'undefined') {
                    try {
                        firebaseConfig = JSON.parse(__firebase_config);
                        if (!firebaseConfig.projectId) {
                            throw new Error("Firebase config is missing projectId.");
                        }

                        app = initializeApp(firebaseConfig);
                        db = getFirestore(app);
                        auth = getAuth(app);
                        
                        onAuthStateChanged(auth, async (user) => {
                            if (user) {
                                userId = user.uid;
                                document.getElementById('user-id').textContent = userId;
                                initOverlay();
                            } else {
                                // Fallback to an anonymous user if token is not available
                                const anonymousUser = await signInAnonymously(auth);
                                userId = anonymousUser.user.uid;
                                document.getElementById('user-id').textContent = userId;
                                initOverlay();
                            }
                        });

                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        
                    } catch (e) {
                        throw new Error(`Invalid Firebase configuration: ${e.message}`);
                    }
                } else {
                    showMessageBox("Warning: Firebase configuration not found. Running in local mode.", 'error');
                    console.warn("Firebase configuration is not defined. Running in local mode.");
                    userId = crypto.randomUUID();
                    document.getElementById('user-id').textContent = userId;
                    // Initialize the overlay with local state
                    currentGameState = initialGameState;
                    updateUI(currentGameState);
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessageBox(`Error initializing Firebase: ${error.message}`, 'error');
            } finally {
                // Ensure the loading overlay is always hidden
                document.getElementById('loading-overlay').style.display = 'none';
                isInitialized = true;
            }
        };

        const getGameStateRef = () => {
            if (!db || !userId) {
                return null;
            }
            return doc(db, `artifacts/${appId}/users/${userId}/kdm_stats/game_state`);
        };


        // --- Initial State and Data ---
        const initialSurvivors = [
            { id: 'survivor-1', name: 'Survivor 1', survival: 0, insanity: 0, head: 0, body: 0, hands: 0, feet: 0, waist: 0, bleed: 0, maxBleed: 5, headInjury: 'none', bodyInjury: 'none', handsInjury: 'none', feetInjury: 'none', waistInjury: 'none' },
            { id: 'survivor-2', name: 'Survivor 2', survival: 0, insanity: 0, head: 0, body: 0, hands: 0, feet: 0, waist: 0, bleed: 0, maxBleed: 5, headInjury: 'none', bodyInjury: 'none', handsInjury: 'none', feetInjury: 'none', waistInjury: 'none' },
            { id: 'survivor-3', name: 'Survivor 3', survival: 0, insanity: 0, head: 0, body: 0, hands: 0, feet: 0, waist: 0, bleed: 0, maxBleed: 5, headInjury: 'none', bodyInjury: 'none', handsInjury: 'none', feetInjury: 'none', waistInjury: 'none' },
            { id: 'survivor-4', name: 'Survivor 4', survival: 0, insanity: 0, head: 0, body: 0, hands: 0, feet: 0, waist: 0, bleed: 0, maxBleed: 5, headInjury: 'none', bodyInjury: 'none', handsInjury: 'none', feetInjury: 'none', waistInjury: 'none' },
        ];

        const initialMonster = {
            name: 'White Lion',
            currentLife: 20,
            maxLife: 20
        };
        
        const initialGameState = {
            year: 1,
            survivors: initialSurvivors,
            monster: initialMonster
        };

        // --- UI Rendering Functions ---
        const renderSurvivors = (survivors) => {
            const container = document.getElementById('survivor-grid');
            container.innerHTML = '';
            survivors.forEach(survivor => {
                const card = document.createElement('div');
                card.id = `card-${survivor.id}`;
                card.className = "bg-gray-800 p-4 rounded-lg";
                card.innerHTML = `
                    <p class="text-xl font-bold mb-2">${survivor.name}</p>
                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-300">
                        <p>Survival: <span id="${survivor.id}-survival">${survivor.survival}</span></p>
                        <p>Insanity: <span id="${survivor.id}-insanity">${survivor.insanity}</span></p>
                        <p>Head: <span id="${survivor.id}-head">${survivor.head}</span><span id="${survivor.id}-head-injury" class="ml-2 text-red-400">${survivor.headInjury === 'low' ? 'L' : survivor.headInjury === 'high' ? 'H' : ''}</span></p>
                        <p>Body: <span id="${survivor.id}-body">${survivor.body}</span><span id="${survivor.id}-body-injury" class="ml-2 text-red-400">${survivor.bodyInjury === 'low' ? 'L' : survivor.bodyInjury === 'high' ? 'H' : ''}</span></p>
                        <p>Hands: <span id="${survivor.id}-hands">${survivor.hands}</span><span id="${survivor.id}-hands-injury" class="ml-2 text-red-400">${survivor.handsInjury === 'low' ? 'L' : survivor.handsInjury === 'high' ? 'H' : ''}</span></p>
                        <p>Feet: <span id="${survivor.id}-feet">${survivor.feet}</span><span id="${survivor.id}-feet-injury" class="ml-2 text-red-400">${survivor.feetInjury === 'low' ? 'L' : survivor.feetInjury === 'high' ? 'H' : ''}</span></p>
                        <p>Waist: <span id="${survivor.id}-waist">${survivor.waist}</span><span id="${survivor.id}-waist-injury" class="ml-2 text-red-400">${survivor.waistInjury === 'low' ? 'L' : survivor.waistInjury === 'high' ? 'H' : ''}</span></p>
                    </div>
                    <div class="mt-4">
                        <label class="text-sm text-gray-400">Bleed: <span id="${survivor.id}-bleed-text">${survivor.bleed} / ${survivor.maxBleed}</span></label>
                        <div class="relative pt-1">
                            <div class="overflow-hidden h-3 flex text-xs rounded bg-gray-600">
                                <div id="${survivor.id}-bleed-fill" style="width: ${survivor.bleed / survivor.maxBleed * 100}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-red-500 transition-all duration-300"></div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        };

        const renderMonster = (monster) => {
            document.getElementById('monster-name').textContent = monster.name;
            const lifeText = document.getElementById('monster-life-text');
            const lifeFill = document.getElementById('monster-life-fill');
            
            // Calculate Life percentage based on current and max Life
            const lifePercentage = (monster.currentLife / monster.maxLife) * 100;
            lifeFill.style.width = `${Math.max(0, lifePercentage)}%`;
            lifeText.textContent = `${monster.currentLife} / ${monster.maxLife}`;
            lifeFill.classList.remove('bg-red-500', 'bg-yellow-500', 'bg-green-500');
            if (lifePercentage > 50) {
                lifeFill.classList.add('bg-green-500');
            } else if (lifePercentage > 25) {
                lifeFill.classList.add('bg-yellow-500');
            } else {
                lifeFill.classList.add('bg-red-500');
            }
        };

        const renderControlPanel = (gameState) => {
            const controlsContainer = document.getElementById('survivor-controls');
            controlsContainer.innerHTML = '';
            
            // Set values for Monster fields
            document.getElementById('monster-name-input').value = gameState.monster.name;
            document.getElementById('monster-life-input').value = gameState.monster.currentLife;
            document.getElementById('monster-max-life-input').value = gameState.monster.maxLife;

            // Render survivor name inputs
            gameState.survivors.forEach(survivor => {
                const survivorDiv = document.createElement('div');
                survivorDiv.className = "mb-4 border-b border-gray-700 pb-2";
                survivorDiv.innerHTML = `<label for="${survivor.id}-name-input" class="block text-gray-300 font-semibold mb-2">Survivor Name</label>
                    <input id="${survivor.id}-name-input" type="text" value="${survivor.name}" class="w-full p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                `;
                controlsContainer.appendChild(survivorDiv);
                
                // Add stat controls
                const statContainer = document.createElement('div');
                statContainer.className = "grid grid-cols-2 gap-4 mt-2";
                
                const stats = ['survival', 'insanity', 'head', 'body', 'hands', 'feet', 'waist', 'bleed', 'maxBleed'];
                const injuryParts = ['head', 'body', 'hands', 'feet', 'waist'];

                stats.forEach(stat => {
                    const isInjuryPart = injuryParts.includes(stat);
                    const isMaxBleed = stat === 'maxBleed';
                    const isNumerical = !isInjuryPart;

                    let labelText = stat.replace(/([A-Z])/g, ' $1').trim();
                    if (isMaxBleed) labelText = 'Max Bleed';

                    statContainer.innerHTML += `
                        <div class="flex items-center">
                            <label for="${survivor.id}-${stat}-input" class="block text-gray-300 font-semibold text-sm capitalize flex-grow">${labelText}</label>
                            <input id="${survivor.id}-${stat}-input" type="number" value="${survivor[stat]}" class="stat-input p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            ${isInjuryPart ? `<span id="${survivor.id}-${stat}-injury-toggle" data-survivor-id="${survivor.id}" data-part="${stat}" class="injury-toggle ml-2">${survivor[`${stat}Injury`] === 'low' ? 'L' : survivor[`${stat}Injury`] === 'high' ? 'H' : ''}</span>` : ''}
                        </div>
                    `;
                });
                survivorDiv.appendChild(statContainer);
            });
        };

        // --- Firestore Listeners and Data Flow ---
        const initOverlay = async () => {
            const gameStateRef = getGameStateRef();
            if (!gameStateRef) {
                // If Firebase is not initialized, use local state
                currentGameState = initialGameState;
                updateUI(currentGameState);
                return;
            }
            
            onSnapshot(gameStateRef, async (doc) => {
                if (doc.exists()) {
                    const fetchedState = doc.data();
                    
                    const updatedSurvivors = initialSurvivors.map(initialSurvivor => {
                        const fetchedSurvivor = fetchedState.survivors.find(s => s.id === initialSurvivor.id) || {};
                        return { ...initialSurvivor, ...fetchedSurvivor };
                    });
                    
                    currentGameState = {
                        ...initialGameState,
                        ...fetchedState,
                        survivors: updatedSurvivors
                    };

                    updateUI(currentGameState);
                } else {
                    currentGameState = initialGameState;
                    await setDoc(gameStateRef, initialGameState);
                }
            });
        };

        const updateUI = (gameState) => {
            document.getElementById('game-year').textContent = `Lantern Year: ${gameState.year}`;
            renderMonster(gameState.monster);
            renderSurvivors(gameState.survivors);
        };

        // --- Control Panel Logic ---
        const controlPanel = document.getElementById('control-panel');
        const mainOverlay = document.getElementById('main-overlay');

        const toggleControlPanel = async () => {
            if (!isInitialized) {
                showMessageBox("App is initializing. Please wait a moment.", 'info');
                return;
            }

            const isVisible = controlPanel.classList.toggle('is-visible');
            mainOverlay.classList.toggle('blur-sm');

            if (isVisible) {
                renderControlPanel(currentGameState);
            }
        };

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                toggleControlPanel();
            }
        });

        document.getElementById('close-btn').addEventListener('click', toggleControlPanel);

        controlPanel.addEventListener('click', async (e) => {
            if (!currentGameState) return;

            const toggle = e.target.closest('.injury-toggle');
            if (toggle) {
                const survivorId = toggle.dataset.survivorId;
                const part = toggle.dataset.part;
                const injuryProp = `${part}Injury`;
                
                const survivorIndex = currentGameState.survivors.findIndex(s => s.id === survivorId);
                if (survivorIndex !== -1) {
                    const currentInjury = currentGameState.survivors[survivorIndex][injuryProp];
                    let newInjury = 'none';
                    if (currentInjury === 'none') {
                        newInjury = 'low';
                    } else if (currentInjury === 'low') {
                        newInjury = 'high';
                    }
                    currentGameState.survivors[survivorIndex][injuryProp] = newInjury;
                }
                
                updateUI(currentGameState);

                const gameStateRef = getGameStateRef();
                if (gameStateRef) {
                    try {
                        await setDoc(gameStateRef, currentGameState);
                        showMessageBox("Game state saved to Firestore.");
                    } catch (error) {
                        console.error("Error updating document:", error);
                        showMessageBox("Error saving data to Firestore. Check console.", 'error');
                    }
                } else {
                    console.log("Running in local mode. Data not saved to Firestore.");
                }
            }
        });

        controlPanel.addEventListener('input', async (e) => {
            if (!currentGameState) return;

            const fieldId = e.target.id;
            let value = e.target.type === 'number' ? parseInt(e.target.value, 10) : e.target.value;
            
            // Check for NaN and set to 0 to prevent Firestore errors
            if (e.target.type === 'number' && isNaN(value)) {
                value = 0;
            }
            
            if (fieldId === 'year-input') {
                currentGameState.year = value;
            }
            else if (fieldId === 'monster-name-input') {
                currentGameState.monster.name = value;
            }
            else if (fieldId === 'monster-life-input') {
                currentGameState.monster.currentLife = value;
            } else if (fieldId === 'monster-max-life-input') {
                currentGameState.monster.maxLife = value;
            }
            else if (fieldId.startsWith('survivor-') && fieldId.endsWith('-input')) {
                const parts = fieldId.split('-');
                const statName = parts[parts.length - 2];
                const survivorId = parts.slice(0, -2).join('-');
                const survivorIndex = currentGameState.survivors.findIndex(s => s.id === survivorId);
                if (survivorIndex !== -1) {
                    currentGameState.survivors[survivorIndex][statName] = value;
                }
            }
            
            updateUI(currentGameState);

            const gameStateRef = getGameStateRef();
            if (gameStateRef) {
                try {
                    await setDoc(gameStateRef, currentGameState);
                    showMessageBox("Game state saved to Firestore.");
                } catch (error) {
                    console.error("Error updating document:", error);
                    showMessageBox("Error saving data to Firestore. Check console.", 'error');
                }
            } else {
                console.log("Running in local mode. Data not saved to Firestore.");
            }
        });

        window.onload = setupFirebase;
    </script>
</body>
</html>
