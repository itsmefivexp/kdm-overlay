<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDM Stream Overlay</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
    <style>
        /* Base styles for the body and main container */
        body {
            font-family: 'Uncial Antiqua', serif;
            color: #f3f4f6;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(1px);
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 84rem;
            margin: auto;
            border: 2px solid #555;
            background: rgba(0, 0, 0, 0.6);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
            position: relative;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        
        .blur-sm {
            filter: blur(4px);
        }

        /* Responsive padding for the main container */
        @media (min-width: 768px) {
            body {
                padding: 2rem;
            }
            .container {
                padding: 2.5rem;
            }
        }

        /* Header and text styles */
        .text-center { text-align: center; }
        .mb-6 { margin-bottom: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-5xl { font-size: 3rem; }
        .font-bold { font-weight: 700; }
        .mb-2 { margin-bottom: 0.5rem; }
        .tracking-wide { letter-spacing: 0.025em; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-semibold { font-weight: 600; }
        .text-gray-400 { color: #9ca3af; }

        /* Main content layout */
        .main-content {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            gap: 1.5rem;
            justify-content: center;
        }
        
        @media (min-width: 640px) {
            .main-content {
                flex-direction: row;
            }
        }

        /* Survivor section */
        .survivor-section {
            flex-grow: 1;
            min-width: 0;
        }
        .border-b { border-bottom-width: 1px; }
        .border-gray-600 { border-color: #4b5563; }
        .pb-2 { padding-bottom: 0.5rem; }

        .survivor-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        /* Survivor card styling and responsiveness */
        .survivor-card {
            background-color: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            flex-basis: 24%;
            min-width: 250px;
        }
        @media (max-width: 1024px) {
            .survivor-card {
                flex-basis: 48%;
            }
        }
        @media (max-width: 640px) {
            .survivor-card {
                flex-basis: 100%;
            }
        }

        /* Survivor stat grid and text */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #d1d5db;
        }
        .ml-2 { margin-left: 0.5rem; }
        .text-red-400 { color: #f87171; }
        
        /* Bleed bar styling */
        .mt-4 { margin-top: 1rem; }
        .text-gray-400 { color: #9ca3af; }
        .bleed-bar {
            position: relative;
            padding-top: 0.25rem;
        }
        .bleed-bg {
            overflow: hidden;
            height: 0.75rem;
            display: flex;
            border-radius: 0.25rem;
            background-color: #4b5563;
        }
        .bleed-fill {
            transition: width 0.3s ease-in-out;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            text-align: center;
            white-space: nowrap;
            color: white;
            justify-content: center;
            background-color: #ef4444; /* Initial red color */
        }
        .text-sm { font-size: 0.875rem; }

        /* Monster section */
        .monster-section {
            flex-grow: 1;
            margin-top: 1.5rem;
        }
        @media (min-width: 640px) {
            .monster-section {
                margin-top: 0;
            }
        }
        @media (min-width: 1024px) {
            .monster-section {
                width: 33.333333%;
            }
        }

        .monster-card {
            min-height: 120px;
            background-color: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        
        /* Monster life bar styling */
        .relative { position: relative; }
        .pt-1 { padding-top: 0.25rem; }
        .overflow-hidden { overflow: hidden; }
        .h-4 { height: 1rem; }
        .text-xs { font-size: 0.75rem; }
        .rounded { border-radius: 0.25rem; }
        .bg-red-800 { background-color: #991b1b; }
        .bg-green-500 { background-color: #22c55e; }
        .bg-yellow-500 { background-color: #eab308; }
        .bg-red-500 { background-color: #ef4444; }
        .transition-all { transition-property: all; }
        .duration-300 { transition-duration: 300ms; }
        .mt-1 { margin-top: 0.25rem; }
        .text-right { text-align: right; }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 1.5rem;
            color: #6b7280;
            font-size: 0.875rem;
        }

        /* Control Panel styles */
        .control-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background: rgba(17, 24, 39, 0.95);
            border: 2px solid #4b5563;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.9);
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 0.5rem;
            padding: 2rem;
        }
        
        .control-panel.is-visible {
            visibility: visible;
            opacity: 1;
        }

        /* Control Panel input and button styles */
        .mb-4 { margin-bottom: 1rem; }
        .text-gray-300 { color: #d1d5db; }
        .input-field {
            width: 100%;
            padding: 0.5rem;
            background-color: #374151;
            border-radius: 0.375rem;
            color: #fff;
            border: 1px solid #4b5563;
            outline: none;
        }
        .input-field:focus {
            ring-width: 2px;
            ring-color: #6366f1;
        }
        .space-y-4 > * + * { margin-top: 1rem; }
        .input-label {
            display: block;
            color: #d1d5db;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .close-btn {
            margin-top: 1.5rem;
            width: 100%;
            padding: 0.5rem;
            background-color: #dc2626;
            color: #fff;
            border-radius: 0.375rem;
            font-weight: 700;
            transition: background-color 0.2s;
        }
        .close-btn:hover { background-color: #b91c1c; }
        .hidden { display: none; }
        .text-yellow-200 { color: #fef08a; }
        .bg-yellow-900 { background-color: #78350f; }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Injury toggle */
        .injury-toggle {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            line-height: 1.5rem;
            text-align: center;
            border: 1px solid #4b5563;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            margin-left: 0.5rem;
        }
        
        .injury-low {
            background-color: #fca5a5;
            color: #7f1d1d;
        }
        
        .injury-high {
            background-color: #b91c1c;
            color: white;
        }

        /* Message box */
        .message-box {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            padding: 1rem;
            background-color: #1f2937;
            color: #f3f4f6;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: none;
            transition: all 0.3s ease-in-out;
            z-index: 50;
        }
        .message-box.show {
            display: block;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Main Overlay Container -->
    <div id="main-overlay" class="container w-full max-w-7xl mx-auto rounded-lg p-6 md:p-10">

        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-5xl font-bold mb-2 tracking-wide">Kingdom Death: Monster</h1>
            <p id="game-year" class="text-xl md:text-2xl font-semibold text-gray-400">Lantern Year: 1</p>
        </header>

        <!-- Main stats container with new horizontal layout -->
        <main class="main-content">

            <!-- Survivor Stats Section -->
            <section id="survivor-stats" class="survivor-section">
                <h2 class="text-2xl font-bold border-b border-gray-600 pb-2">Survivors</h2>
                <!-- This grid now acts as a flex container for the cards -->
                <div id="survivor-grid" class="survivor-grid">
                    <!-- Survivor cards will be dynamically inserted here -->
                </div>
            </section>

            <!-- Monster Stats Section -->
            <section id="monster-stats" class="monster-section">
                <h2 class="text-2xl font-bold border-b border-gray-600 pb-2">Monster</h2>
                <div id="monster-card" class="monster-card">
                    <p class="text-xl font-bold mb-2"><span id="monster-name">White Lion</span></p>
                    <div class="mb-2">
                        <label class="text-sm text-gray-400" for="monster-life">Life</label>
                        <div class="relative pt-1">
                            <div class="overflow-hidden h-4 text-xs flex rounded bg-red-800">
                                <div id="monster-life-fill" style="width: 100%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center transition-all duration-300"></div>
                            </div>
                        </div>
                        <p id="monster-life-text" class="text-sm text-right mt-1">20 / 20</p>
                    </div>
                </div>
            </section>

        </main>

        <!-- General info and Footer -->
        <footer class="footer">
            <p>Overlay powered by Firestore. Press <kbd>Esc</kbd> to toggle controls.</p>
            <p>Your User ID: <span id="user-id"></span></p>
        </footer>
    </div>

    <!-- Control Panel -->
    <div id="control-panel" class="control-panel">
        <h2 class="text-3xl font-bold mb-4 text-center">Control Panel</h2>

        <!-- Warning message for local mode -->
        <div id="local-mode-warning" class="hidden bg-yellow-900 text-yellow-200 p-3 rounded-md mb-4 text-center text-sm">
            Not connected to Firestore. Your changes will not be saved.
        </div>

        <!-- General Game Info Controls -->
        <div class="mb-6 border-b border-gray-700 pb-4">
            <label for="year-input" class="input-label">Game Year</label>
            <input id="year-input" type="number" min="1" class="input-field">
        </div>

        <!-- Monster Controls -->
        <div class="mb-6 border-b border-gray-700 pb-4">
            <h3 class="text-xl font-bold mb-2">Monster Stats</h3>
            <div class="mb-2">
                <label for="monster-name-input" class="input-label">Monster Name</label>
                <input id="monster-name-input" type="text" class="input-field">
            </div>
            <div class="mb-2">
                <label for="monster-life-input" class="input-label">Current Life</label>
                <input id="monster-life-input" type="number" min="0" class="input-field">
            </div>
            <div>
                <label for="monster-max-life-input" class="input-label">Max Life</label>
                <input id="monster-max-life-input" type="number" min="1" class="input-field">
            </div>
        </div>

        <!-- Survivor Controls -->
        <div id="survivor-controls" class="space-y-4">
            <h3 class="text-xl font-bold mb-2">Survivor Stats</h3>
            <!-- Survivor input fields will be dynamically added here -->
        </div>

        <button id="close-btn" class="close-btn">Close</button>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="message-box"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : null;
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        let currentGameState = null;
        let isConnected = false;
        let hasDataLoaded = false;

        const showMessageBox = (message, type = 'info') => {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = `message-box show`;
            if (type === 'error') {
                messageBox.classList.add('bg-red-800', 'text-white');
            } else {
                messageBox.classList.add('bg-gray-800', 'text-white');
            }
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        };

        const hideLoadingOverlay = () => {
            document.getElementById('loading-overlay').style.display = 'none';
        };

        const setupFirebase = async () => {
            if (firebaseConfigString && appId) {
                try {
                    const firebaseConfig = JSON.parse(firebaseConfigString);
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    // The onAuthStateChanged listener will handle all sign-in logic
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            // A user is signed in.
                            userId = user.uid;
                            document.getElementById('user-id').textContent = userId;
                            document.getElementById('local-mode-warning').classList.add('hidden');
                            isConnected = true;
                            initDataListener();
                            console.log("Successfully connected to Firestore.");
                        } else {
                            // No user is signed in.
                            if (initialAuthToken) {
                                // Use the provided custom token if available
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                // Fallback to anonymous sign-in
                                await signInAnonymously(auth);
                            }
                        }
                        
                        // Hide the loading overlay after the initial auth state check is complete.
                        // This prevents a flash of content if authentication is slow.
                        if (!hasDataLoaded) {
                            hideLoadingOverlay();
                            hasDataLoaded = true;
                        }
                    });

                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    showMessageBox("Connection failed. Check console for details.", 'error');
                    fallbackToLocalMode();
                }
            } else {
                console.warn("Firebase configuration not found. Running in local mode.");
                showMessageBox("Could not find database credentials. The app is running in local mode.", 'error');
                fallbackToLocalMode();
            }
        };

        const fallbackToLocalMode = () => {
            userId = crypto.randomUUID();
            document.getElementById('user-id').textContent = userId;
            currentGameState = initialGameState;
            updateUI(currentGameState);
            hideLoadingOverlay();
            isConnected = false;
            document.getElementById('local-mode-warning').classList.remove('hidden');
        };
        
        // This function now points to a public, shared location
        const getGameStateRef = () => {
            if (!db || !appId) {
                return null;
            }
            return doc(db, `artifacts/${appId}/public/data/kdm_stats/game_state`);
        };

        const initialSurvivors = [
            { id: 'survivor-1', color: 'Blue', name: 'Survivor 1', survival: 0, insanity: 0, head: 0, body: 0, hands: 0, feet: 0, waist: 0, bleed: 0, maxBleed: 5, headInjury: 'none', bodyInjury: 'none', handsInjury: 'none', feetInjury: 'none', waistInjury: 'none' },
            { id: 'survivor-2', color: 'Red', name: 'Survivor 2', survival: 0, insanity: 0, head: 0, body: 0, hands: 0, feet: 0, waist: 0, bleed: 0, maxBleed: 5, headInjury: 'none', bodyInjury: 'none', handsInjury: 'none', feetInjury: 'none', waistInjury: 'none' },
            { id: 'survivor-3', color: 'Green', name: 'Survivor 3', survival: 0, insanity: 0, head: 0, body: 0, hands: 0, feet: 0, waist: 0, bleed: 0, maxBleed: 5, headInjury: 'none', bodyInjury: 'none', handsInjury: 'none', feetInjury: 'none', waistInjury: 'none' },
            { id: 'survivor-4', color: 'White', name: 'Survivor 4', survival: 0, insanity: 0, head: 0, body: 0, hands: 0, feet: 0, waist: 0, bleed: 0, maxBleed: 5, headInjury: 'none', bodyInjury: 'none', handsInjury: 'none', feetInjury: 'none', waistInjury: 'none' },
        ];

        const initialMonster = {
            name: 'White Lion',
            currentLife: 20,
            maxLife: 20
        };
        
        const initialGameState = {
            year: 1,
            survivors: initialSurvivors,
            monster: initialMonster
        };

        const renderSurvivors = (survivors) => {
            const container = document.getElementById('survivor-grid');
            container.innerHTML = '';
            survivors.forEach(survivor => {
                const card = document.createElement('div');
                card.id = `card-${survivor.id}`;
                card.className = "survivor-card";
                card.innerHTML = `
                    <p class="text-xl font-bold mb-2">${survivor.color}: ${survivor.name}</p>
                    <div class="stat-grid">
                        <p>Survival: <span id="${survivor.id}-survival">${survivor.survival}</span></p>
                        <p>Insanity: <span id="${survivor.id}-insanity">${survivor.insanity}</span></p>
                        <p>Head: <span id="${survivor.id}-head">${survivor.head}</span><span id="${survivor.id}-head-injury" class="ml-2 text-red-400">${survivor.headInjury === 'low' ? 'L' : survivor.headInjury === 'high' ? 'H' : ''}</span></p>
                        <p>Body: <span id="${survivor.id}-body">${survivor.body}</span><span id="${survivor.id}-body-injury" class="ml-2 text-red-400">${survivor.bodyInjury === 'low' ? 'L' : survivor.bodyInjury === 'high' ? 'H' : ''}</span></p>
                        <p>Hands: <span id="${survivor.id}-hands">${survivor.hands}</span><span id="${survivor.id}-hands-injury" class="ml-2 text-red-400">${survivor.handsInjury === 'low' ? 'L' : survivor.handsInjury === 'high' ? 'H' : ''}</span></p>
                        <p>Feet: <span id="${survivor.id}-feet">${survivor.feet}</span><span id="${survivor.id}-feet-injury" class="ml-2 text-red-400">${survivor.feetInjury === 'low' ? 'L' : survivor.feetInjury === 'high' ? 'H' : ''}</span></p>
                        <p>Waist: <span id="${survivor.id}-waist">${survivor.waist}</span><span id="${survivor.id}-waist-injury" class="ml-2 text-red-400">${survivor.waistInjury === 'low' ? 'L' : survivor.waistInjury === 'high' ? 'H' : ''}</span></p>
                    </div>
                    <div class="mt-4">
                        <label class="text-sm text-gray-400">Bleed: <span id="${survivor.id}-bleed-text">${survivor.bleed} / ${survivor.maxBleed}</span></label>
                        <div class="bleed-bar">
                            <div class="bleed-bg">
                                <div id="${survivor.id}-bleed-fill" style="width: ${survivor.bleed / survivor.maxBleed * 100}%" class="bleed-fill"></div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        };

        const renderMonster = (monster) => {
            document.getElementById('monster-name').textContent = monster.name;
            const lifeText = document.getElementById('monster-life-text');
            const lifeFill = document.getElementById('monster-life-fill');
            
            const lifePercentage = (monster.currentLife / monster.maxLife) * 100;
            lifeFill.style.width = `${Math.max(0, lifePercentage)}%`;
            lifeText.textContent = `${monster.currentLife} / ${monster.maxLife}`;
            
            lifeFill.className = lifeFill.className.replace(/bg-(red|yellow|green)-500/g, '').trim();
            if (lifePercentage > 50) {
                lifeFill.classList.add('bg-green-500');
            } else if (lifePercentage > 25) {
                lifeFill.classList.add('bg-yellow-500');
            } else {
                lifeFill.classList.add('bg-red-500');
            }
        };

        const renderControlPanel = (gameState) => {
            const controlsContainer = document.getElementById('survivor-controls');
            controlsContainer.innerHTML = '';
            
            document.getElementById('monster-name-input').value = gameState.monster.name;
            document.getElementById('monster-life-input').value = gameState.monster.currentLife;
            document.getElementById('monster-max-life-input').value = gameState.monster.maxLife;

            gameState.survivors.forEach(survivor => {
                const survivorDiv = document.createElement('div');
                survivorDiv.className = "mb-4 border-b border-gray-700 pb-2";
                survivorDiv.innerHTML = `<label for="${survivor.id}-name-input" class="input-label">${survivor.color} Survivor Name</label>
                    <input id="${survivor.id}-name-input" type="text" value="${survivor.name}" class="input-field">
                `;
                controlsContainer.appendChild(survivorDiv);
                
                const statContainer = document.createElement('div');
                statContainer.className = "grid grid-cols-2 gap-4 mt-2";
                
                const stats = ['survival', 'insanity', 'head', 'body', 'hands', 'feet', 'waist', 'bleed', 'maxBleed'];
                const injuryParts = ['head', 'body', 'hands', 'feet', 'waist'];

                stats.forEach(stat => {
                    const isInjuryPart = injuryParts.includes(stat);
                    const isMaxBleed = stat === 'maxBleed';
                    let labelText = stat.replace(/([A-Z])/g, ' $1').trim();
                    if (isMaxBleed) labelText = 'Max Bleed';

                    statContainer.innerHTML += `
                        <div class="flex items-center">
                            <label for="${survivor.id}-${stat}-input" class="block text-gray-300 font-semibold text-sm capitalize flex-grow">${labelText}</label>
                            <input id="${survivor.id}-${stat}-input" type="number" value="${survivor[stat]}" class="stat-input p-2 bg-gray-700 rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            ${isInjuryPart ? `<span id="${survivor.id}-${stat}-injury-toggle" data-survivor-id="${survivor.id}" data-part="${stat}" class="injury-toggle ml-2">${survivor[`${stat}Injury`] === 'low' ? 'L' : survivor[`${stat}Injury`] === 'high' ? 'H' : ''}</span>` : ''}
                        </div>
                    `;
                });
                survivorDiv.appendChild(statContainer);
            });
        };

        const initDataListener = async () => {
            const gameStateRef = getGameStateRef();
            if (!gameStateRef) {
                fallbackToLocalMode();
                return;
            }
            
            const unsubscribe = onSnapshot(gameStateRef, async (doc) => {
                if (doc.exists()) {
                    const fetchedState = doc.data();
                    const updatedSurvivors = initialSurvivors.map(initialSurvivor => {
                        const fetchedSurvivor = fetchedState.survivors.find(s => s.id === initialSurvivor.id) || {};
                        return { ...initialSurvivor, ...fetchedSurvivor };
                    });
                    
                    currentGameState = {
                        ...initialGameState,
                        ...fetchedState,
                        survivors: updatedSurvivors
                    };

                    updateUI(currentGameState);

                } else {
                    currentGameState = initialGameState;
                    await setDoc(gameStateRef, initialGameState);
                }
            }, (error) => {
                console.error("Error listening to document:", error);
                showMessageBox("Error loading data from Firestore. Check console for details.", 'error');
                unsubscribe();
                fallbackToLocalMode();
            });
        };

        const updateUI = (gameState) => {
            document.getElementById('game-year').textContent = `Lantern Year: ${gameState.year}`;
            renderMonster(gameState.monster);
            renderSurvivors(gameState.survivors);
        };

        const controlPanel = document.getElementById('control-panel');
        const mainOverlay = document.getElementById('main-overlay');

        const toggleControlPanel = () => {
            const isVisible = controlPanel.classList.toggle('is-visible');
            mainOverlay.classList.toggle('blur-sm');

            if (isVisible) {
                renderControlPanel(currentGameState);
            }
        };

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                toggleControlPanel();
            }
        });

        document.getElementById('close-btn').addEventListener('click', toggleControlPanel);

        controlPanel.addEventListener('click', async (e) => {
            if (!currentGameState) return;

            const toggle = e.target.closest('.injury-toggle');
            if (toggle) {
                const survivorId = toggle.dataset.survivorId;
                const part = toggle.dataset.part;
                const injuryProp = `${part}Injury`;
                
                const survivorIndex = currentGameState.survivors.findIndex(s => s.id === survivorId);
                if (survivorIndex !== -1) {
                    const currentInjury = currentGameState.survivors[survivorIndex][injuryProp];
                    let newInjury = 'none';
                    if (currentInjury === 'none') {
                        newInjury = 'low';
                    } else if (currentInjury === 'low') {
                        newInjury = 'high';
                    }
                    currentGameState.survivors[survivorIndex][injuryProp] = newInjury;
                }
                
                updateUI(currentGameState);

                if (isConnected) {
                    const gameStateRef = getGameStateRef();
                    try {
                        await setDoc(gameStateRef, currentGameState);
                        showMessageBox("Game state saved to Firestore.");
                    } catch (error) {
                        console.error("Error updating document:", error);
                        showMessageBox("Error saving data to Firestore. Check console.", 'error');
                    }
                } else {
                    console.log("Running in local mode. Data not saved to Firestore.");
                }
            }
        });

        controlPanel.addEventListener('input', async (e) => {
            if (!currentGameState) return;

            const fieldId = e.target.id;
            let value = e.target.type === 'number' ? parseInt(e.target.value, 10) : e.target.value;
            
            if (e.target.type === 'number' && isNaN(value)) {
                value = 0;
            }
            
            if (fieldId === 'year-input') {
                currentGameState.year = value;
            }
            else if (fieldId === 'monster-name-input') {
                currentGameState.monster.name = value;
            }
            else if (fieldId === 'monster-life-input') {
                currentGameState.monster.currentLife = value;
            } else if (fieldId === 'monster-max-life-input') {
                currentGameState.monster.maxLife = value;
            }
            else if (fieldId.startsWith('survivor-') && fieldId.endsWith('-input')) {
                const parts = fieldId.split('-');
                const statName = parts[parts.length - 2];
                const survivorId = parts.slice(0, -2).join('-');
                const survivorIndex = currentGameState.survivors.findIndex(s => s.id === survivorId);
                if (survivorIndex !== -1) {
                    currentGameState.survivors[survivorIndex][statName] = value;
                }
            }
            
            updateUI(currentGameState);

            if (isConnected) {
                const gameStateRef = getGameStateRef();
                try {
                    await setDoc(gameStateRef, currentGameState);
                    showMessageBox("Game state saved to Firestore.");
                } catch (error) {
                    console.error("Error saving document:", error);
                    showMessageBox("Error saving data to Firestore. Check console.", 'error');
                }
            } else {
                console.log("Running in local mode. Data not saved to Firestore.");
            }
        });

        window.onload = setupFirebase;
    </script>
</body>
</html>
